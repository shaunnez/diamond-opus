###############################################################################
# Diamond Platform â€” Local Development Stack
#
# Usage:
#   docker compose up -d                 # start all services
#   docker compose up -d postgres azurite servicebus  # infra only
#   docker compose logs -f worker        # tail worker logs
#   docker compose down -v               # tear down + delete volumes
#
# The stack uses the demo feed (FEED=demo) so no Nivoda credentials are needed.
###############################################################################

services:
  # ---------------------------------------------------------------------------
  # Infrastructure
  # ---------------------------------------------------------------------------

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: diamond
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./sql/full_schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d diamond"]
      interval: 3s
      timeout: 3s
      retries: 10

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    command: azurite-blob --blobHost 0.0.0.0 --blobPort 10000 --loose
    ports:
      - "10000:10000"
    volumes:
      - azurite:/data
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "10000"]
      interval: 3s
      timeout: 3s
      retries: 10

  # SQL Server required by Service Bus Emulator
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "Diamond1Strong!"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "Diamond1Strong!", "-C", "-Q", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 15

  servicebus:
    image: mcr.microsoft.com/azure-messaging/servicebus-emulator:latest
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      SQL_SERVER: mssql
      MSSQL_SA_PASSWORD: "Diamond1Strong!"
      ACCEPT_EULA: "Y"
    ports:
      - "5672:5672"
    volumes:
      - ./docker/servicebus-emulator/Config.json:/ServiceBus_Emulator/ConfigFiles/Config.json:ro
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:5300/health 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------

  demo-feed-api:
    build:
      context: .
      dockerfile: docker/Dockerfile.demo-feed-api
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/diamond
      DEMO_FEED_API_PORT: "4000"
    ports:
      - "4000:4000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:4000/api/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  ingestion-proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile.ingestion-proxy
    environment:
      NODE_ENV: production
      PORT: "3001"
      NIVODA_ENDPOINT: "${NIVODA_ENDPOINT:-}"
      NIVODA_USERNAME: "${NIVODA_USERNAME:-}"
      NIVODA_PASSWORD: "${NIVODA_PASSWORD:-}"
      INTERNAL_SERVICE_TOKEN: "local-internal-token"
      NIVODA_PROXY_RATE_LIMIT: "25"
      NIVODA_PROXY_RATE_LIMIT_MAX_WAIT_MS: "60000"
      NIVODA_PROXY_TIMEOUT_MS: "60000"
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    depends_on:
      postgres:
        condition: service_healthy
      azurite:
        condition: service_healthy
      servicebus:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: "3000"
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/diamond
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      AZURE_SERVICE_BUS_CONNECTION_STRING: "Endpoint=sb://servicebus;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
      DEMO_FEED_API_URL: "http://demo-feed-api:4000"
      PG_POOL_MAX: "2"
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  storefront:
    build:
      context: .
      dockerfile: docker/Dockerfile.storefront
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_URL: "http://api:3000"
    ports:
      - "8081:80"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/"]
      interval: 5s
      timeout: 3s
      retries: 10

  dashboard:
    build:
      context: .
      dockerfile: docker/Dockerfile.dashboard
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_URL: "http://api:3000"
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/"]
      interval: 5s
      timeout: 3s
      retries: 10

  scheduler:
    build:
      context: .
      dockerfile: docker/Dockerfile.scheduler
    depends_on:
      postgres:
        condition: service_healthy
      azurite:
        condition: service_healthy
      servicebus:
        condition: service_healthy
      demo-feed-api:
        condition: service_healthy
      ingestion-proxy:
        condition: service_healthy
    environment:
      NODE_ENV: production
      FEED: demo
      RUN_TYPE: full
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/diamond
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      AZURE_SERVICE_BUS_CONNECTION_STRING: "Endpoint=sb://servicebus;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
      DEMO_FEED_API_URL: "http://demo-feed-api:4000"
      NIVODA_PROXY_BASE_URL: "http://ingestion-proxy:3001"
      INTERNAL_SERVICE_TOKEN: "local-internal-token"
      PG_POOL_MAX: "2"
      MAX_SCHEDULER_RECORDS: "500"
    profiles:
      - pipeline

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
    depends_on:
      postgres:
        condition: service_healthy
      servicebus:
        condition: service_healthy
      demo-feed-api:
        condition: service_healthy
      ingestion-proxy:
        condition: service_healthy
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/diamond
      AZURE_SERVICE_BUS_CONNECTION_STRING: "Endpoint=sb://servicebus;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
      DEMO_FEED_API_URL: "http://demo-feed-api:4000"
      NIVODA_PROXY_BASE_URL: "http://ingestion-proxy:3001"
      INTERNAL_SERVICE_TOKEN: "local-internal-token"
      PG_POOL_MAX: "1"
      PG_IDLE_TIMEOUT_MS: "2000"
    profiles:
      - pipeline

  consolidator:
    build:
      context: .
      dockerfile: docker/Dockerfile.consolidator
    depends_on:
      postgres:
        condition: service_healthy
      azurite:
        condition: service_healthy
      servicebus:
        condition: service_healthy
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/diamond
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      AZURE_SERVICE_BUS_CONNECTION_STRING: "Endpoint=sb://servicebus;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;"
      PG_POOL_MAX: "2"
      CONSOLIDATOR_CONCURRENCY: "2"
    profiles:
      - pipeline

volumes:
  pgdata:
  azurite:
