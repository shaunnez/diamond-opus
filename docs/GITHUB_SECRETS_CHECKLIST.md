# GitHub Secrets Checklist

This document lists all GitHub secrets required for the CI/CD pipeline to function correctly.

## How Secrets Flow Through the System

```
GitHub Secrets
     │
     ▼
GitHub Actions Workflow (TF_VAR_* env vars)
     │
     ▼
Terraform Variables
     │
     ▼
Azure Container Apps (container environment variables)
     │
     ▼
Application Code (requireEnv / optionalEnv)
```

**Important:** Some environment variables are auto-generated by Terraform from Azure resources:
- `AZURE_STORAGE_CONNECTION_STRING` - from Storage Account resource
- `AZURE_SERVICE_BUS_CONNECTION_STRING` - from Service Bus resource

These do NOT need GitHub Secrets - Terraform creates them automatically.

## Required Secrets

Configure these in: **GitHub Repository Settings > Secrets and variables > Actions**

For environment-specific secrets, configure in the `staging` environment.

### Azure Authentication (4 secrets)

| Secret Name | Description | Example |
|-------------|-------------|---------|
| `AZURE_CLIENT_ID` | Azure Service Principal Client ID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| `AZURE_CLIENT_SECRET` | Azure Service Principal Client Secret | (secure string) |
| `AZURE_TENANT_ID` | Azure Active Directory Tenant ID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| `AZURE_SUBSCRIPTION_ID` | Azure Subscription ID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |

### Azure Container Registry (3 secrets)

| Secret Name | Description | Example |
|-------------|-------------|---------|
| `ACR_LOGIN_SERVER` | Container Registry login server | `diamondstagingacr.azurecr.io` |
| `ACR_USERNAME` | Container Registry admin username | `diamondstagingacr` |
| `ACR_PASSWORD` | Container Registry admin password | (secure string) |

### Application Configuration (3 secrets)

| Secret Name | Description | TF Variable | Used By |
|-------------|-------------|-------------|---------|
| `ENVIRONMENT_TAG` | Stable environment tag for scheduler | `environment_tag` | Scheduler job |
| `NIVODA_USERNAME` | Nivoda API username (email) | `nivoda_username` | Worker, Scheduler |
| `NIVODA_PASSWORD` | Nivoda API password | `nivoda_password` | Worker, Scheduler |

### Email Alerts (3 secrets)

| Secret Name | Description | TF Variable | Used By |
|-------------|-------------|-------------|---------|
| `RESEND_API_KEY` | Resend API key for email alerts | `resend_api_key` | Worker, Consolidator |
| `ALERT_EMAIL_TO` | Email address for receiving alerts | `alert_email_to` | Worker, Consolidator |
| `ALERT_EMAIL_FROM` | Email address for sending alerts | `alert_email_from` | Worker, Consolidator |

### Database Configuration (3 secrets)

| Secret Name | Description | TF Variable | Used By |
|-------------|-------------|-------------|---------|
| `DATABASE_HOST` | PostgreSQL host (Supabase pooler) | `database_host` | All apps |
| `DATABASE_USERNAME` | PostgreSQL username | `database_username` | All apps |
| `DATABASE_PASSWORD` | PostgreSQL password | `database_password` | All apps |

### API Authentication (1 secret)

| Secret Name | Description | TF Variable | Used By |
|-------------|-------------|-------------|---------|
| `HMAC_SECRETS` | JSON object of HMAC client secrets | `hmac_secrets` | API |

## Total: 17 Secrets

## Environment Variables by Container

### API Container
- `DATABASE_HOST`, `DATABASE_PORT`, `DATABASE_NAME`, `DATABASE_USERNAME`, `DATABASE_PASSWORD`
- `AZURE_STORAGE_CONNECTION_STRING` (auto from Terraform)
- `AZURE_SERVICE_BUS_CONNECTION_STRING` (auto from Terraform)
- `HMAC_SECRETS`
- `NIVODA_ENDPOINT`, `NIVODA_USERNAME`, `NIVODA_PASSWORD`
- `AZURE_SUBSCRIPTION_ID`, `AZURE_RESOURCE_GROUP`, `AZURE_SCHEDULER_JOB_NAME`

### Worker Container
- `DATABASE_HOST`, `DATABASE_PORT`, `DATABASE_NAME`, `DATABASE_USERNAME`, `DATABASE_PASSWORD`
- `AZURE_STORAGE_CONNECTION_STRING` (auto from Terraform)
- `AZURE_SERVICE_BUS_CONNECTION_STRING` (auto from Terraform)
- `NIVODA_ENDPOINT`, `NIVODA_USERNAME`, `NIVODA_PASSWORD`
- `RESEND_API_KEY`, `ALERT_EMAIL_TO`, `ALERT_EMAIL_FROM`

### Consolidator Container
- `DATABASE_HOST`, `DATABASE_PORT`, `DATABASE_NAME`, `DATABASE_USERNAME`, `DATABASE_PASSWORD`
- `AZURE_STORAGE_CONNECTION_STRING` (auto from Terraform)
- `AZURE_SERVICE_BUS_CONNECTION_STRING` (auto from Terraform)
- `RESEND_API_KEY`, `ALERT_EMAIL_TO`, `ALERT_EMAIL_FROM`

### Scheduler Job
- `DATABASE_HOST`, `DATABASE_PORT`, `DATABASE_NAME`, `DATABASE_USERNAME`, `DATABASE_PASSWORD`
- `AZURE_STORAGE_CONNECTION_STRING` (auto from Terraform)
- `AZURE_SERVICE_BUS_CONNECTION_STRING` (auto from Terraform)
- `NIVODA_ENDPOINT`, `NIVODA_USERNAME`, `NIVODA_PASSWORD`

## Environment-Specific Configuration

For production deployment, you'll need to create a separate GitHub Environment called `prod` with its own set of secrets (or override the staging environment secrets if using a single environment).

### Staging vs Production Differences

| Secret | Staging Value | Production Value |
|--------|---------------|------------------|
| `ENVIRONMENT_TAG` | `staging` | `prod` |
| `ACR_LOGIN_SERVER` | `diamondstagingacr.azurecr.io` | `diamondprodacr.azurecr.io` |
| `NIVODA_USERNAME` | staging Nivoda account | production Nivoda account |
| `DATABASE_HOST` | staging Supabase pooler | production Supabase pooler |
| `DATABASE_USERNAME` | staging database user | production database user |
| `DATABASE_PASSWORD` | staging database password | production database password |

## Validation

After configuring secrets, the workflow includes a debug step that validates the presence of critical secrets:

```yaml
- name: Debug staging secrets present
  run: |
    [ -n "${{ secrets.ACR_LOGIN_SERVER }}" ] && echo "ACR_LOGIN_SERVER ok" || (echo "ACR_LOGIN_SERVER missing" && exit 1)
    ...
```

## Security Notes

1. **Never commit secrets to the repository** - Always use GitHub Secrets
2. **Rotate secrets regularly** - Especially after team member departures
3. **Use least-privilege principle** - Service principals should have minimal required permissions
4. **Monitor secret access** - GitHub provides audit logs for secret access
5. **HMAC_SECRETS format** - Must be valid JSON: `{"clientId":"secretValue"}`

## Obtaining Values

### Azure Credentials
```bash
# Create Service Principal with Contributor role
az ad sp create-for-rbac --name "diamond-github-actions" \
  --role Contributor \
  --scopes /subscriptions/<subscription-id>
```

### ACR Credentials
```bash
# Get ACR admin credentials
az acr credential show --name <acr-name>
```

### Resend API Key
1. Sign up at https://resend.com
2. Create an API key in the dashboard
3. Verify your sending domain

### Supabase Database
1. Go to Supabase Dashboard > Project Settings > Database
2. Find the connection string under "Connection Pooling"
3. Extract host, username, and password
