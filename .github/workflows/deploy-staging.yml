name: Deploy Staging

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  actions: write
  contents: read

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    environment: staging
    # Only run if CI workflow succeeded (or on manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    strategy:
      matrix:
        app: [api, scheduler, worker, consolidator, dashboard]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ACR_LOGIN_SERVER }}/diamond-${{ matrix.app }}
          tags: |
            type=sha,format=short,prefix=
            type=raw,value=staging

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.app }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: Azure/login@v2.3.0
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}'

      - name: Get commit SHA
        id: sha
        run: |
          # Use workflow_run SHA if available (triggered by CI), otherwise use current SHA (manual trigger)
          if [ -n "$WORKFLOW_RUN_SHA" ]; then
            SHA="$WORKFLOW_RUN_SHA"
          else
            SHA="$GITHUB_SHA"
          fi
          echo "short=${SHA::7}" >> $GITHUB_OUTPUT
          echo "full=${SHA}" >> $GITHUB_OUTPUT
        env:
          WORKFLOW_RUN_SHA: ${{ github.event.workflow_run.head_sha }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Deploy Container Apps
        env:
          RESOURCE_GROUP: diamond-staging-rg
          ENVIRONMENT: ${{ secrets.AZURE_CONTAINER_APP_ENV_STAGING }}
          ACR_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ steps.sha.outputs.short }}
        run: |
          # Helper function to update an existing container app (created by Terraform)
          # This workflow only updates images - Terraform manages container creation with env vars
          deploy_app() {
            local name=$1
            local container_name=$2
            local image=$3

            if az containerapp show --name "$name" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
              echo "Updating existing app: $name (container: $container_name)"
              az containerapp update \
                --name "$name" \
                --resource-group "$RESOURCE_GROUP" \
                --container-name "$container_name" \
                --image "$image"
            else
              echo "WARNING: Container app '$name' does not exist - skipping."
              echo "Container apps must be created by Terraform (infrastructure.yml) with proper environment variables."
              echo "Run 'terraform apply' in infrastructure/terraform/environments/staging to create the container."
            fi
          }

          # Deploy API (container name 'api' as defined in Terraform)
          deploy_app "diamond-staging-api" "api" "$ACR_SERVER/diamond-api:$IMAGE_TAG"

          # Deploy Worker (container name 'worker' as defined in Terraform)
          deploy_app "diamond-staging-worker" "worker" "$ACR_SERVER/diamond-worker:$IMAGE_TAG"

          # Deploy Consolidator (container name 'consolidator' as defined in Terraform)
          deploy_app "diamond-staging-consolidator" "consolidator" "$ACR_SERVER/diamond-consolidator:$IMAGE_TAG"

          # Scheduler is managed by Terraform (infrastructure.yml) with Schedule trigger
          # Only update the image if the job exists, don't create it here
          if az containerapp job show --name "diamond-staging-scheduler" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "Updating scheduler job image"
            az containerapp job update \
              --name "diamond-staging-scheduler" \
              --resource-group "$RESOURCE_GROUP" \
              --container-name "scheduler" \
              --image "$ACR_SERVER/diamond-scheduler:$IMAGE_TAG"
          else
            echo "Scheduler job not found - will be created by Terraform"
          fi

          # Deploy Dashboard (container name 'dashboard' as defined in Terraform)
          deploy_app "diamond-staging-dashboard" "dashboard" "$ACR_SERVER/diamond-dashboard:$IMAGE_TAG"

      - name: Diagnose Consolidator Scale Rules
        env:
          RESOURCE_GROUP: diamond-staging-rg
        run: |
          echo "=== CONSOLIDATOR DIAGNOSTICS ==="
          echo ""
          echo "### Current Container App Configuration ###"
          az containerapp show \
            --name diamond-staging-consolidator \
            --resource-group "$RESOURCE_GROUP" \
            --query "{
              name: name,
              minReplicas: properties.template.scale.minReplicas,
              maxReplicas: properties.template.scale.maxReplicas,
              scaleRules: properties.template.scale.rules,
              cpu: properties.template.containers[0].resources.cpu,
              memory: properties.template.containers[0].resources.memory,
              image: properties.template.containers[0].image
            }" \
            -o json || echo "Failed to get consolidator details"

          echo ""
          echo "### Worker Scale Rules (for comparison) ###"
          az containerapp show \
            --name diamond-staging-worker \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.template.scale" \
            -o json || echo "Failed to get worker details"

          echo ""
          echo "### Expected Consolidator Scale Rule ###"
          echo "Should have: custom_scale_rule with azure-servicebus on 'consolidate' queue"

      - name: Trigger Infrastructure Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('Triggering infrastructure workflow to ensure Terraform state is in sync...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'infrastructure.yml',
              ref: 'main',
              inputs: {
                environment: 'staging',
                action: 'apply'
              }
            });
            console.log('Infrastructure workflow triggered successfully');

