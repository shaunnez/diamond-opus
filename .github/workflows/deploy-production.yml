name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, or SHA)'
        required: false
        default: 'main'
      skip_build:
        description: 'Skip build and use existing images from staging'
        required: false
        type: boolean
        default: false

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    environment: production
    if: ${{ !inputs.skip_build }}

    strategy:
      matrix:
        app: [api, scheduler, worker, consolidator, dashboard]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ACR_LOGIN_SERVER }}/diamond-${{ matrix.app }}
          tags: |
            type=sha,prefix=
            type=raw,value=production
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.app }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: ${{ always() && (needs.build-and-push.result == 'success' || inputs.skip_build) }}
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Azure Login
        uses: Azure/login@v2.3.0
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}'

      - name: Get commit SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ inputs.skip_build }}" = "true" ]; then
            echo "tag=staging" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ steps.sha.outputs.short }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy Container Apps
        env:
          RESOURCE_GROUP: diamond-prod-rg
          ENVIRONMENT: ${{ secrets.AZURE_CONTAINER_APP_ENV_PROD }}
          ACR_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          # Helper function to create or update a container app
          deploy_app() {
            local name=$1
            local image=$2
            local ingress=$3
            local target_port=$4

            if az containerapp show --name "$name" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
              echo "Updating existing app: $name"
              az containerapp update \
                --name "$name" \
                --resource-group "$RESOURCE_GROUP" \
                --container-name "$name" \
                --image "$image"
            else
              echo "Creating new app: $name"
              if [ "$ingress" = "external" ]; then
                az containerapp create \
                  --name "$name" \
                  --resource-group "$RESOURCE_GROUP" \
                  --environment "$ENVIRONMENT" \
                  --image "$image" \
                  --ingress "$ingress" \
                  --target-port "$target_port" \
                  --registry-server "$ACR_SERVER" \
                  --registry-username "${{ secrets.ACR_USERNAME }}" \
                  --registry-password "${{ secrets.ACR_PASSWORD }}"
              else
                az containerapp create \
                  --name "$name" \
                  --resource-group "$RESOURCE_GROUP" \
                  --environment "$ENVIRONMENT" \
                  --image "$image" \
                  --registry-server "$ACR_SERVER" \
                  --registry-username "${{ secrets.ACR_USERNAME }}" \
                  --registry-password "${{ secrets.ACR_PASSWORD }}"
              fi
            fi
          }

          # Helper function to create or update a container app job
          deploy_job() {
            local name=$1
            local image=$2

            if az containerapp job show --name "$name" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
              echo "Updating existing job: $name"
              az containerapp job update \
                --name "$name" \
                --resource-group "$RESOURCE_GROUP" \
                --container-name "$name" \
                --image "$image"
            else
              echo "Creating new job: $name"
              az containerapp job create \
                --name "$name" \
                --resource-group "$RESOURCE_GROUP" \
                --environment "$ENVIRONMENT" \
                --image "$image" \
                --trigger-type "Manual" \
                --replica-timeout 1800 \
                --registry-server "$ACR_SERVER" \
                --registry-username "${{ secrets.ACR_USERNAME }}" \
                --registry-password "${{ secrets.ACR_PASSWORD }}"
            fi
          }

          # Deploy API (external ingress on port 3000)
          deploy_app "diamond-prod-api" "$ACR_SERVER/diamond-api:$IMAGE_TAG" "external" 3000

          # Deploy Worker (no ingress - consumes from queue)
          deploy_app "diamond-prod-worker" "$ACR_SERVER/diamond-worker:$IMAGE_TAG" "none" 0

          # Deploy Consolidator (no ingress - consumes from queue)
          deploy_app "diamond-prod-consolidator" "$ACR_SERVER/diamond-consolidator:$IMAGE_TAG" "none" 0

          # Deploy Scheduler (job, not continuous app)
          deploy_job "diamond-prod-scheduler" "$ACR_SERVER/diamond-scheduler:$IMAGE_TAG"

          # Deploy Dashboard (external ingress on port 80 - nginx)
          deploy_app "diamond-prod-dashboard" "$ACR_SERVER/diamond-dashboard:$IMAGE_TAG" "external" 80

      - name: Create deployment tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "production-$(date +%Y%m%d-%H%M%S)" -m "Production deployment from ${{ inputs.ref }}"
          git push origin --tags
