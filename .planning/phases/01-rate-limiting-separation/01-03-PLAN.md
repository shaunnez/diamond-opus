---
phase: 01-rate-limiting-separation
plan: 03
type: execute
wave: 2
depends_on: [01-02]
files_modified:
  - infrastructure/terraform/modules/container-apps/main.tf
autonomous: true
requirements: [RATE-02]

must_haves:
  truths:
    - "Scheduler routes Nivoda requests through ingestion proxy"
    - "Worker routes Nivoda requests through ingestion proxy"
    - "NIVODA_PROXY_BASE_URL set to ingestion proxy FQDN"
    - "Terraform plan shows env var updates"
  artifacts:
    - path: "infrastructure/terraform/modules/container-apps/main.tf"
      provides: "Scheduler NIVODA_PROXY_BASE_URL env var"
      contains: "NIVODA_PROXY_BASE_URL"
    - path: "infrastructure/terraform/modules/container-apps/main.tf"
      provides: "Worker NIVODA_PROXY_BASE_URL env var"
      contains: "NIVODA_PROXY_BASE_URL"
  key_links:
    - from: "azurerm_container_app_job.scheduler.template.container.env"
      to: "azurerm_container_app.ingestion_proxy.ingress[0].fqdn"
      via: "NIVODA_PROXY_BASE_URL reference"
      pattern: "NIVODA_PROXY_BASE_URL.*ingestion_proxy.*fqdn"
    - from: "azurerm_container_app.worker.template.container.env"
      to: "azurerm_container_app.ingestion_proxy.ingress[0].fqdn"
      via: "NIVODA_PROXY_BASE_URL reference"
      pattern: "NIVODA_PROXY_BASE_URL.*ingestion_proxy.*fqdn"
---

<objective>
Configure scheduler and worker Container Apps to route all Nivoda GraphQL requests through the dedicated ingestion proxy.

Purpose: Enforce 25 req/s global rate limit by channeling all ingestion traffic through single-replica proxy bottleneck.

Output: Scheduler and worker env vars updated with NIVODA_PROXY_BASE_URL pointing to ingestion proxy internal FQDN.
</objective>

<execution_context>
@/Users/shaunnesbitt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shaunnesbitt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-rate-limiting-separation/01-RESEARCH.md
@.planning/phases/01-rate-limiting-separation/01-02-SUMMARY.md

# Existing Terraform resources
@infrastructure/terraform/modules/container-apps/main.tf

# Proxy transport initialization logic
@packages/nivoda/src/adapter.ts
</context>

<tasks>

<task type="auto">
  <name>Update scheduler to use ingestion proxy</name>
  <files>
infrastructure/terraform/modules/container-apps/main.tf
  </files>
  <action>
Update scheduler Container App Job resource (`azurerm_container_app_job.scheduler`):

**Add two new env blocks** in the template.container section (after existing NIVODA_* env vars):

1. NIVODA_PROXY_BASE_URL:
```hcl
env {
  name  = "NIVODA_PROXY_BASE_URL"
  value = "https://${azurerm_container_app.ingestion_proxy.ingress[0].fqdn}"
}
```

2. INTERNAL_SERVICE_TOKEN (already exists as secret, reference it):
```hcl
env {
  name        = "INTERNAL_SERVICE_TOKEN"
  secret_name = "internal-service-token"
}
```

**Placement:** Add after existing Nivoda-related env vars (NIVODA_ENDPOINT, NIVODA_USERNAME, NIVODA_PASSWORD).

**How this works (from RESEARCH.md Pattern 3):**
When `NIVODA_PROXY_BASE_URL` is set, the Nivoda adapter in `packages/nivoda/src/adapter.ts` (lines 179-199) automatically switches from direct GraphQL client to ProxyGraphqlTransport. The adapter validates that INTERNAL_SERVICE_TOKEN is also set and fails fast if missing.

**Validation:** Verify INTERNAL_SERVICE_TOKEN env var doesn't already exist in scheduler config (avoid duplicates). If it exists, don't add duplicate.
  </action>
  <verify>
```bash
grep -A 2 'name  = "NIVODA_PROXY_BASE_URL"' infrastructure/terraform/modules/container-apps/main.tf | grep scheduler -B 20
grep -A 2 'secret_name = "internal-service-token"' infrastructure/terraform/modules/container-apps/main.tf | grep scheduler -B 20
terraform -chdir=infrastructure/terraform/modules/container-apps validate
```
  </verify>
  <done>
- Scheduler env vars include NIVODA_PROXY_BASE_URL with ingestion proxy FQDN
- Scheduler env vars include INTERNAL_SERVICE_TOKEN
- Terraform validates successfully
  </done>
</task>

<task type="auto">
  <name>Update worker to use ingestion proxy</name>
  <files>
infrastructure/terraform/modules/container-apps/main.tf
  </files>
  <action>
Update worker Container App resource (`azurerm_container_app.worker`):

**Add two new env blocks** in the template.container section (after existing NIVODA_* env vars):

1. NIVODA_PROXY_BASE_URL:
```hcl
env {
  name  = "NIVODA_PROXY_BASE_URL"
  value = "https://${azurerm_container_app.ingestion_proxy.ingress[0].fqdn}"
}
```

2. INTERNAL_SERVICE_TOKEN (already exists as secret, reference it):
```hcl
env {
  name        = "INTERNAL_SERVICE_TOKEN"
  secret_name = "internal-service-token"
}
```

**Placement:** Add after existing Nivoda-related env vars (NIVODA_ENDPOINT, NIVODA_USERNAME, NIVODA_PASSWORD).

**Same adapter logic:** Worker also uses Nivoda adapter from `packages/nivoda/src/adapter.ts` which detects NIVODA_PROXY_BASE_URL and switches to proxy transport automatically.

**Validation:** Verify INTERNAL_SERVICE_TOKEN env var doesn't already exist in worker config (avoid duplicates). If it exists, don't add duplicate.
  </action>
  <verify>
```bash
grep -A 2 'name  = "NIVODA_PROXY_BASE_URL"' infrastructure/terraform/modules/container-apps/main.tf | grep worker -B 20
grep -A 2 'secret_name = "internal-service-token"' infrastructure/terraform/modules/container-apps/main.tf | grep worker -B 20
terraform -chdir=infrastructure/terraform/modules/container-apps validate
terraform -chdir=infrastructure/terraform/modules/container-apps fmt -check
```
  </verify>
  <done>
- Worker env vars include NIVODA_PROXY_BASE_URL with ingestion proxy FQDN
- Worker env vars include INTERNAL_SERVICE_TOKEN
- Terraform validates and formats correctly
  </done>
</task>

</tasks>

<verification>
Overall plan verification:

```bash
# Verify scheduler config
grep -B 5 -A 5 'NIVODA_PROXY_BASE_URL' infrastructure/terraform/modules/container-apps/main.tf | grep -A 10 scheduler

# Verify worker config
grep -B 5 -A 5 'NIVODA_PROXY_BASE_URL' infrastructure/terraform/modules/container-apps/main.tf | grep -A 10 worker

# Check FQDN references
grep 'ingestion_proxy.ingress\[0\].fqdn' infrastructure/terraform/modules/container-apps/main.tf

# Terraform validation
cd infrastructure/terraform/modules/container-apps
terraform validate
terraform fmt -check
```

Expected output:
- Both scheduler and worker have NIVODA_PROXY_BASE_URL env vars
- Both reference ingestion_proxy.ingress[0].fqdn
- Terraform validates successfully
</verification>

<success_criteria>
1. Scheduler env vars include NIVODA_PROXY_BASE_URL pointing to ingestion proxy FQDN
2. Worker env vars include NIVODA_PROXY_BASE_URL pointing to ingestion proxy FQDN
3. Both services have INTERNAL_SERVICE_TOKEN configured
4. Terraform validates successfully
5. No duplicate env var declarations
</success_criteria>

<output>
After completion, create `.planning/phases/01-rate-limiting-separation/01-03-SUMMARY.md`
</output>
