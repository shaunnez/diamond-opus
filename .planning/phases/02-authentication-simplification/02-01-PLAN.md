---
phase: 02-authentication-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/middleware/auth.ts
  - packages/shared/src/utils/hash.ts
  - packages/shared/src/constants.ts
  - packages/api/__tests__/auth.test.ts
  - packages/api/__tests__/routes.integration.test.ts
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03

must_haves:
  truths:
    - "authMiddleware accepts requests with a valid X-API-Key header and calls next()"
    - "authMiddleware rejects requests with no auth header with 401 Unauthorized"
    - "authMiddleware rejects requests with HMAC headers (x-client-id/x-timestamp/x-signature) with 401 — those headers are no longer recognized"
    - "No HMAC validation code exists in auth.ts or hash.ts"
    - "All auth unit tests and routes integration tests pass with npm test"
  artifacts:
    - path: "packages/api/src/middleware/auth.ts"
      provides: "API key-only auth middleware"
      contains: "validateApiKey"
    - path: "packages/shared/src/utils/hash.ts"
      provides: "sha256 only (hmacSha256 and secureCompare removed)"
      exports: ["sha256"]
    - path: "packages/shared/src/constants.ts"
      provides: "Constants without HMAC_TIMESTAMP_TOLERANCE_SECONDS"
    - path: "packages/api/__tests__/auth.test.ts"
      provides: "Auth unit tests for API key path only"
    - path: "packages/api/__tests__/routes.integration.test.ts"
      provides: "Integration tests without HMAC env setup"
  key_links:
    - from: "packages/api/src/middleware/auth.ts"
      to: "packages/shared/src/utils/hash.ts"
      via: "sha256 import (only)"
      pattern: "import.*sha256.*from.*@diamond/shared"
    - from: "packages/api/src/middleware/auth.ts"
      to: "@diamond/database"
      via: "getApiKeyByHash, updateApiKeyLastUsed"
      pattern: "getApiKeyByHash"
---

<objective>
Remove HMAC authentication from the API middleware and all supporting code, leaving only API key authentication.

Purpose: Simplify the auth system to a single, auditable mechanism. HMAC was used as a fallback but is no longer needed now that the ingestion proxy uses internal service token auth separately.
Output: Simplified auth.ts (~50 lines vs ~170), pruned hash.ts and constants.ts, updated test files with HMAC describe blocks removed.
</objective>

<execution_context>
@/Users/shaunnesbitt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shaunnesbitt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/api/src/middleware/auth.ts
@packages/shared/src/utils/hash.ts
@packages/shared/src/constants.ts
@packages/api/__tests__/auth.test.ts
@packages/api/__tests__/routes.integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify authMiddleware to API key-only</name>
  <files>packages/api/src/middleware/auth.ts</files>
  <action>
Rewrite packages/api/src/middleware/auth.ts to remove all HMAC-related code. The result must:

1. Remove these imports: `hmacSha256`, `secureCompare`, `parseJsonEnv`, `HMAC_TIMESTAMP_TOLERANCE_SECONDS`
   - Keep: `sha256`, `notify`, `NotifyCategory` from `@diamond/shared`
   - Keep: `getApiKeyByHash`, `updateApiKeyLastUsed` from `@diamond/database`

2. Delete the following functions entirely:
   - `getHmacSecrets()` and `cachedHmacSecrets` variable
   - `validateHmacSignature()`
   - `HmacSecrets` interface
   - `captureRawBody()` export (zero external consumers — server.ts uses express.json verify callback instead)

3. Keep these unchanged:
   - `AUTH_FAILURE_THRESHOLD`, `AUTH_FAILURE_WINDOW_MS`, `FailureRecord` interface, `authFailures` Map
   - `trackAuthFailure()` function
   - `validateApiKey()` function

4. Replace `authMiddleware` with the simplified version:
   ```typescript
   export async function authMiddleware(
     req: Request,
     res: Response,
     next: NextFunction,
   ): Promise<void> {
     const apiKey = req.headers["x-api-key"] as string | undefined;
     if (apiKey) {
       const isValid = await validateApiKey(apiKey);
       if (isValid) {
         next();
         return;
       }
     }
     const source = req.ip ?? req.socket?.remoteAddress ?? 'unknown';
     trackAuthFailure(source);
     res.status(401).json({
       error: {
         code: "UNAUTHORIZED",
         message: "Invalid or missing API key",
       },
     });
   }
   ```

Note: The `rawBody` field on Request (declared in server.ts global namespace) is retained because `express.json verify` in server.ts still populates it — but auth.ts no longer reads it.
  </action>
  <verify>Run: npm run typecheck -w @diamond/api 2>&1 | head -30</verify>
  <done>No TypeScript errors in packages/api. authMiddleware function body contains no reference to HMAC, rawBody, x-client-id, x-timestamp, or x-signature.</done>
</task>

<task type="auto">
  <name>Task 2: Remove hmacSha256/secureCompare from shared, remove HMAC constant</name>
  <files>
    packages/shared/src/utils/hash.ts
    packages/shared/src/constants.ts
  </files>
  <action>
**packages/shared/src/utils/hash.ts:**
Remove `hmacSha256` and `secureCompare` functions. Remove the `createHmac` and `timingSafeEqual` imports (no longer needed). Keep only:

```typescript
import { createHash } from 'node:crypto';

export function sha256(data: string): string {
  return createHash('sha256').update(data).digest('hex');
}
```

**packages/shared/src/constants.ts:**
Remove line 26: `export const HMAC_TIMESTAMP_TOLERANCE_SECONDS = 300; // 5 minutes`

No other lines in constants.ts change. `parseJsonEnv` stays in env.ts (used by other code, just no longer used by auth.ts after Task 1).

After both edits, verify no remaining consumer of `hmacSha256` or `secureCompare` or `HMAC_TIMESTAMP_TOLERANCE_SECONDS` exists in non-test source files:
```bash
grep -rn "hmacSha256\|secureCompare\|HMAC_TIMESTAMP" packages/ apps/ --include="*.ts" | grep -v "__tests__" | grep -v "tests/" | grep -v "dist/"
```
Expected result: zero matches (tests/local/helpers.ts is addressed in Plan 02).
  </action>
  <verify>Run: npm run typecheck -w @diamond/shared 2>&1 | head -20</verify>
  <done>hash.ts exports only sha256. constants.ts contains no HMAC_TIMESTAMP_TOLERANCE_SECONDS. TypeScript check passes for @diamond/shared.</done>
</task>

<task type="auto">
  <name>Task 3: Update test files to remove HMAC test cases</name>
  <files>
    packages/api/__tests__/auth.test.ts
    packages/api/__tests__/routes.integration.test.ts
  </files>
  <action>
**packages/api/__tests__/auth.test.ts:**

1. Remove import of `hmacSha256` from `@diamond/shared` (keep `sha256` — used in API key test)
2. Remove `process.env['HMAC_SECRETS'] = ...` line from `beforeEach`
3. Remove the entire `describe('HMAC Authentication', ...)` block (lines 73-160 in current file — 4 test cases: valid HMAC, expired timestamp, tampered body, unknown client)
4. Remove `rawBody?: string` from the `mockReq` type annotation (no longer needed)
5. Remove `mockReq.rawBody = ''` assignments

Keep intact:
- `describe('API Key Authentication', ...)` block — both test cases
- `describe('No Authentication', ...)` block — the reject test

**packages/api/__tests__/routes.integration.test.ts:**

1. In `beforeEach`: Remove the `process.env['HMAC_SECRETS'] = JSON.stringify({...})` block (lines 56-59)
2. In `afterEach`: Remove `delete process.env['HMAC_SECRETS']` line
3. Do NOT change any other test cases — all route tests use API key auth via `mockGetApiKeyByHash` and are unaffected

After edits, run the test suite:
```bash
npm run test -w @diamond/api 2>&1 | tail -20
```
  </action>
  <verify>npm run test -w @diamond/api 2>&1 | tail -30</verify>
  <done>All tests in @diamond/api pass. No HMAC describe block in auth.test.ts. No HMAC_SECRETS env setup in routes.integration.test.ts.</done>
</task>

</tasks>

<verification>
Run full typecheck and test suite:
```bash
npm run typecheck 2>&1 | grep -E "error|Error" | head -20
npm run test -w @diamond/api 2>&1 | tail -20
npm run test -w @diamond/shared 2>&1 | tail -10
```

Confirm no HMAC code remains in auth.ts:
```bash
grep -n "hmac\|HMAC\|x-client-id\|x-timestamp\|x-signature\|rawBody\|captureRawBody" packages/api/src/middleware/auth.ts
```
Expected: zero matches (case-insensitive grep for hmac).
</verification>

<success_criteria>
- authMiddleware passes requests with valid X-API-Key, rejects all others with 401
- hash.ts exports only sha256
- HMAC_TIMESTAMP_TOLERANCE_SECONDS removed from constants.ts
- HMAC describe block removed from auth.test.ts
- HMAC_SECRETS env setup removed from routes.integration.test.ts
- All @diamond/api and @diamond/shared tests pass
- TypeScript compiles without errors across both packages
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-simplification/02-01-SUMMARY.md`
</output>
