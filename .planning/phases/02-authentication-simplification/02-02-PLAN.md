---
phase: 02-authentication-simplification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/routes/system.ts
  - packages/api/src/swagger/generator.ts
  - tests/local/helpers.ts
  - docs/DIAMOND_OPUS.md
  - .env.example
  - packages/api/README.md
  - docs/GITHUB_SECRETS_CHECKLIST.md
  - CLAUDE.md
autonomous: true
requirements:
  - AUTH-03
  - AUTH-04

must_haves:
  truths:
    - "OpenAPI spec contains no HMACAuth security scheme reference on any endpoint"
    - "Swagger generator description does not mention HMAC as authentication option"
    - "Local e2e test helpers authenticate via X-API-Key header, not HMAC headers"
    - "DIAMOND_OPUS.md Authentication section documents API key-only auth"
    - ".env.example contains no HMAC_SECRETS entry"
    - "packages/api/README.md contains no HMAC references"
    - "GITHUB_SECRETS_CHECKLIST.md contains no HMAC_SECRETS references"
    - "CLAUDE.md Authentication section documents API key-only auth and has no HMAC_SECRETS in env vars"
  artifacts:
    - path: "packages/api/src/routes/system.ts"
      provides: "system config route with ApiKeyAuth-only security"
    - path: "packages/api/src/swagger/generator.ts"
      provides: "Swagger generator without HMAC mentions in description"
    - path: "tests/local/helpers.ts"
      provides: "API helpers using X-API-Key header"
    - path: "docs/DIAMOND_OPUS.md"
      provides: "Updated authentication documentation"
    - path: ".env.example"
      provides: "Example env without HMAC_SECRETS"
    - path: "packages/api/README.md"
      provides: "API README with API key-only authentication documentation"
    - path: "docs/GITHUB_SECRETS_CHECKLIST.md"
      provides: "Secrets checklist with no HMAC_SECRETS entries"
    - path: "CLAUDE.md"
      provides: "Developer guide with API key-only auth and no HMAC_SECRETS in env vars"
  key_links:
    - from: "tests/local/helpers.ts"
      to: "API_BASE_URL"
      via: "X-API-Key header in apiGet/apiPost"
      pattern: "x-api-key.*LOCAL_API_KEY"
    - from: "packages/api/src/routes/system.ts"
      to: "OpenAPI spec"
      via: "security array annotation"
      pattern: "ApiKeyAuth.*\\[\\]"
---

<objective>
Remove HMAC references from OpenAPI/Swagger documentation, local e2e test helpers, docs, environment configuration, API README, GitHub secrets checklist, and developer guide (CLAUDE.md).

Purpose: Ensure all documentation, developer tooling, and example configuration reflects the simplified API key-only authentication system. Developers following any file in the repo will not attempt HMAC auth and receive unexplained 401s.
Output: Consistent single-auth documentation across swagger, docs, e2e helpers, .env.example, README, secrets checklist, and CLAUDE.md.
</objective>

<execution_context>
@/Users/shaunnesbitt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shaunnesbitt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@packages/api/src/routes/system.ts
@packages/api/src/swagger/generator.ts
@tests/local/helpers.ts
@docs/DIAMOND_OPUS.md
@.env.example
@packages/api/README.md
@docs/GITHUB_SECRETS_CHECKLIST.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove HMACAuth from OpenAPI route annotations and swagger generator</name>
  <files>
    packages/api/src/routes/system.ts
    packages/api/src/swagger/generator.ts
  </files>
  <action>
**packages/api/src/routes/system.ts:**

In the JSDoc `@openapi` annotation, change the `security` array from:
```yaml
security:
  - ApiKeyAuth: []
  - HMACAuth: []
```
to:
```yaml
security:
  - ApiKeyAuth: []
```

**packages/api/src/swagger/generator.ts:**

In the `ApiKeyAuth` security scheme description, replace the current multi-line description:
```
API key for authentication.

IMPORTANT: When using API key authentication, HMAC authentication will NOT be attempted as a fallback.
If the API key is invalid, the request will be rejected immediately.

Use either API key OR HMAC authentication, not both.
```

With a clean, accurate description:
```
API key for authentication. Pass your API key in the X-API-Key header.
```

Also check: the `securitySchemes` object should NOT contain an `HMACAuth` entry. Looking at the current generator.ts, HMACAuth was never explicitly defined as a scheme in `securitySchemes` (only ApiKeyAuth exists there) — so no removal needed beyond the description update.

After changes, run swagger generation to verify no errors:
```bash
npm run swagger 2>&1 | tail -5
```
  </action>
  <verify>npm run swagger 2>&1 | tail -5</verify>
  <done>Swagger generates successfully. swagger.json contains no HMACAuth reference. ApiKeyAuth description is clean (no HMAC mention).</done>
</task>

<task type="auto">
  <name>Task 2: Replace HMAC helpers with API key helpers in local e2e tests</name>
  <files>tests/local/helpers.ts</files>
  <action>
Rewrite tests/local/helpers.ts to replace HMAC-based auth with API key auth.

**Remove entirely:**
- `import { createHash, createHmac } from 'node:crypto'` — both hashing functions
- `sha256()` local helper function
- `hmacSha256()` local helper function
- `makeHmacHeaders()` exported function

**Update file header comment** from:
```
 * Expects these environment variables to be set:
 *   DATABASE_URL, API_BASE_URL, HMAC_SECRET, HMAC_CLIENT_ID
```
to:
```
 * Expects these environment variables to be set:
 *   DATABASE_URL, API_BASE_URL, LOCAL_API_KEY
```

**Replace `apiGet`** with:
```typescript
export async function apiGet(path: string): Promise<Response> {
  const apiKey = process.env.LOCAL_API_KEY ?? 'local-dev-key';
  return fetch(`${API_BASE()}${path}`, {
    method: 'GET',
    headers: {
      'x-api-key': apiKey,
      'content-type': 'application/json',
    },
  });
}
```

**Replace `apiPost`** with:
```typescript
export async function apiPost(path: string, body: unknown = {}): Promise<Response> {
  const apiKey = process.env.LOCAL_API_KEY ?? 'local-dev-key';
  const bodyStr = JSON.stringify(body);
  return fetch(`${API_BASE()}${path}`, {
    method: 'POST',
    headers: {
      'x-api-key': apiKey,
      'content-type': 'application/json',
    },
    body: bodyStr,
  });
}
```

Keep unchanged:
- `getPool()`, `query()`, `closePool()` database helpers
- `pollUntil()` helper
- `API_BASE()` function
- `pg` import
  </action>
  <verify>Run: npx tsc --noEmit --project tests/local/tsconfig.json 2>&1 || echo "No tsconfig, checking manually"; grep -n "hmac\|HMAC\|createHmac\|makeHmacHeaders\|HMAC_SECRET\|HMAC_CLIENT" tests/local/helpers.ts</verify>
  <done>tests/local/helpers.ts contains no HMAC code. apiGet and apiPost use x-api-key header. No import of node:crypto.</done>
</task>

<task type="auto">
  <name>Task 3: Remove HMAC references from all documentation and configuration files</name>
  <files>
    docs/DIAMOND_OPUS.md
    .env.example
    packages/api/README.md
    docs/GITHUB_SECRETS_CHECKLIST.md
    CLAUDE.md
  </files>
  <action>
**docs/DIAMOND_OPUS.md — Section 7 (REST API), Authentication subsection:**

Replace the current dual-auth documentation:
```
### Authentication

Dual auth system (checked in order):

1. **API Key Auth**: `X-API-Key` header → SHA256 hash against `api_keys` table
2. **HMAC Auth**: `X-Client-Id`, `X-Timestamp`, `X-Signature` headers
   - Canonical string: `METHOD\nPATH\nTIMESTAMP\nSHA256(BODY)`
   - Timestamp tolerance: 300 seconds (5 minutes)
3. Neither valid → 401 Unauthorized
```

With:
```
### Authentication

API key authentication (single mechanism):

1. **API Key Auth**: `X-API-Key` header → SHA256 hash against `api_keys` table
2. Missing or invalid key → 401 Unauthorized

Repeated auth failures from the same IP trigger a Slack alert after 10 failures within 5 minutes.
```

Also update Section 1 Overview, Key Features bullet: Change `- **Dual authentication**: API Key and HMAC signature support` to `- **API key authentication**: SHA256-hashed API keys stored in database`

Also update Section 14, Environment Variables table: Remove the row for `HMAC_SECRETS`.

Also update the Troubleshooting table (Section 15): The entry `API returning 401 | Verify API key hash, check api_keys.last_used_at` is accurate — keep it as-is.

**.env.example:**

Remove this line:
```
HMAC_SECRETS={"shopify":"secret1","internal":"secret2"}
```

The remaining `# API Configuration` section should just contain:
```
# API Configuration
PORT=3000
```

**packages/api/README.md:**

Find the "Authentication" or "Dual authentication" section and update it. Replace any text describing "Dual authentication" as a feature heading or description with "API key authentication". Specifically:
- Change any heading or bullet like "**Dual authentication**: API Key and HMAC signature support" to "**API key authentication**: SHA256-hashed API keys stored in database"
- Remove any documentation of HMAC headers (`X-Client-Id`, `X-Timestamp`, `X-Signature`) and HMAC canonical string construction
- Remove the `HMAC_SECRETS` entry from the Configuration section (env var table or list)
- The updated Authentication section should describe only: pass `X-API-Key` header, value is validated via SHA256 hash against the `api_keys` table, invalid key returns 401

**docs/GITHUB_SECRETS_CHECKLIST.md:**

Remove all 3 occurrences of `HMAC_SECRETS`:
1. Remove the `HMAC_SECRETS` row from the secrets table (the row describing the secret name, value format, and where to get it)
2. Remove `HMAC_SECRETS` from the required secrets list (the checklist of secrets that must be configured before deployment)
3. Remove the `HMAC_SECRETS` entry from the troubleshooting section (any entry explaining what breaks if this secret is missing or misconfigured)

After removal, verify the surrounding content still reads coherently — no orphaned bullet points or broken table formatting.

**CLAUDE.md:**

1. Find the `## Authentication` section (lines 202-206 approximately). It currently documents HMAC as a valid auth mechanism with this structure:
   ```
   Dual auth system (checked in order):
   1. **API Key Auth**: ...
   2. **HMAC Auth**: X-Client-Id, X-Timestamp, X-Signature headers
      - Canonical string: METHOD\nPATH\nTIMESTAMP\nSHA256(BODY)
      - Timestamp tolerance: 300 seconds (5 minutes)
      - Secrets stored in HMAC_SECRETS env var as JSON
   3. Neither valid → 401 Unauthorized
   ```
   Replace with:
   ```
   API key authentication (single mechanism):

   1. **API Key Auth**: `X-API-Key` header → SHA256 hash against `api_keys` table
   2. Missing or invalid key → 401 Unauthorized
   ```

2. Find the `## Core Environment Variables` section. Remove the `HMAC_SECRETS` line (currently documented as `HMAC_SECRETS` — JSON object of client secrets). Keep all other environment variables unchanged.
  </action>
  <verify>
grep -n "HMAC\|hmac\|dual auth\|Dual auth\|HMACAuth" docs/DIAMOND_OPUS.md
grep -n "HMAC_SECRETS" .env.example
grep -n "HMAC\|hmac\|Dual auth\|dual auth" packages/api/README.md
grep -n "HMAC_SECRETS" docs/GITHUB_SECRETS_CHECKLIST.md
grep -n "HMAC\|hmac\|HMAC_SECRETS" CLAUDE.md
  </verify>
  <done>
- DIAMOND_OPUS.md contains no HMAC references and no HMAC_SECRETS row in env vars table
- .env.example contains no HMAC_SECRETS line
- packages/api/README.md contains no HMAC references (no "Dual authentication", no HMAC headers, no HMAC_SECRETS)
- GITHUB_SECRETS_CHECKLIST.md contains no HMAC_SECRETS references (table row, checklist entry, and troubleshooting entry all removed)
- CLAUDE.md Authentication section describes API key-only auth; Core Environment Variables section has no HMAC_SECRETS entry
  </done>
</task>

</tasks>

<verification>
Confirm no stray HMAC references remain in any targeted file:
```bash
grep -n "HMAC\|hmac" packages/api/src/routes/system.ts packages/api/src/swagger/generator.ts tests/local/helpers.ts .env.example
grep -n "HMAC\|dual auth\|Dual auth" docs/DIAMOND_OPUS.md
grep -n "HMAC\|Dual auth\|dual auth" packages/api/README.md
grep -n "HMAC_SECRETS" docs/GITHUB_SECRETS_CHECKLIST.md
grep -n "HMAC\|HMAC_SECRETS" CLAUDE.md
```
Expected: zero matches across all files.

Also confirm swagger still generates cleanly:
```bash
npm run swagger 2>&1 | tail -5
```
</verification>

<success_criteria>
- system.ts security annotation references ApiKeyAuth only
- swagger generator description contains no HMAC mention
- npm run swagger completes without errors
- tests/local/helpers.ts uses x-api-key header in apiGet/apiPost
- DIAMOND_OPUS.md authentication section describes API key-only auth with no HMAC_SECRETS env var row
- .env.example has no HMAC_SECRETS entry
- packages/api/README.md has no HMAC references and no "Dual authentication" heading
- GITHUB_SECRETS_CHECKLIST.md has no HMAC_SECRETS in secrets table, required list, or troubleshooting
- CLAUDE.md Authentication section describes API key-only auth; Core Environment Variables has no HMAC_SECRETS
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-simplification/02-02-SUMMARY.md`
</output>
