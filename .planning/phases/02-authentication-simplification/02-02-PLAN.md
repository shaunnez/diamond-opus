---
phase: 02-authentication-simplification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/routes/system.ts
  - packages/api/src/swagger/generator.ts
  - tests/local/helpers.ts
  - docs/DIAMOND_OPUS.md
  - .env.example
autonomous: true
requirements:
  - AUTH-03
  - AUTH-04

must_haves:
  truths:
    - "OpenAPI spec contains no HMACAuth security scheme reference on any endpoint"
    - "Swagger generator description does not mention HMAC as authentication option"
    - "Local e2e test helpers authenticate via X-API-Key header, not HMAC headers"
    - "DIAMOND_OPUS.md Authentication section documents API key-only auth"
    - ".env.example contains no HMAC_SECRETS entry"
  artifacts:
    - path: "packages/api/src/routes/system.ts"
      provides: "system config route with ApiKeyAuth-only security"
    - path: "packages/api/src/swagger/generator.ts"
      provides: "Swagger generator without HMAC mentions in description"
    - path: "tests/local/helpers.ts"
      provides: "API helpers using X-API-Key header"
    - path: "docs/DIAMOND_OPUS.md"
      provides: "Updated authentication documentation"
    - path: ".env.example"
      provides: "Example env without HMAC_SECRETS"
  key_links:
    - from: "tests/local/helpers.ts"
      to: "API_BASE_URL"
      via: "X-API-Key header in apiGet/apiPost"
      pattern: "x-api-key.*LOCAL_API_KEY"
    - from: "packages/api/src/routes/system.ts"
      to: "OpenAPI spec"
      via: "security array annotation"
      pattern: "ApiKeyAuth.*\\[\\]"
---

<objective>
Remove HMAC references from OpenAPI/Swagger documentation, local e2e test helpers, docs, and environment configuration.

Purpose: Ensure all documentation, developer tooling, and example configuration reflects the simplified API key-only authentication system.
Output: Consistent single-auth documentation across swagger, docs, e2e helpers, and .env.example.
</objective>

<execution_context>
@/Users/shaunnesbitt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shaunnesbitt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@packages/api/src/routes/system.ts
@packages/api/src/swagger/generator.ts
@tests/local/helpers.ts
@docs/DIAMOND_OPUS.md
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove HMACAuth from OpenAPI route annotations and swagger generator</name>
  <files>
    packages/api/src/routes/system.ts
    packages/api/src/swagger/generator.ts
  </files>
  <action>
**packages/api/src/routes/system.ts:**

In the JSDoc `@openapi` annotation, change the `security` array from:
```yaml
security:
  - ApiKeyAuth: []
  - HMACAuth: []
```
to:
```yaml
security:
  - ApiKeyAuth: []
```

**packages/api/src/swagger/generator.ts:**

In the `ApiKeyAuth` security scheme description, replace the current multi-line description:
```
API key for authentication.

IMPORTANT: When using API key authentication, HMAC authentication will NOT be attempted as a fallback.
If the API key is invalid, the request will be rejected immediately.

Use either API key OR HMAC authentication, not both.
```

With a clean, accurate description:
```
API key for authentication. Pass your API key in the X-API-Key header.
```

Also check: the `securitySchemes` object should NOT contain an `HMACAuth` entry. Looking at the current generator.ts, HMACAuth was never explicitly defined as a scheme in `securitySchemes` (only ApiKeyAuth exists there) — so no removal needed beyond the description update.

After changes, run swagger generation to verify no errors:
```bash
npm run swagger 2>&1 | tail -5
```
  </action>
  <verify>npm run swagger 2>&1 | tail -5</verify>
  <done>Swagger generates successfully. swagger.json contains no HMACAuth reference. ApiKeyAuth description is clean (no HMAC mention).</done>
</task>

<task type="auto">
  <name>Task 2: Replace HMAC helpers with API key helpers in local e2e tests</name>
  <files>tests/local/helpers.ts</files>
  <action>
Rewrite tests/local/helpers.ts to replace HMAC-based auth with API key auth.

**Remove entirely:**
- `import { createHash, createHmac } from 'node:crypto'` — both hashing functions
- `sha256()` local helper function
- `hmacSha256()` local helper function
- `makeHmacHeaders()` exported function

**Update file header comment** from:
```
 * Expects these environment variables to be set:
 *   DATABASE_URL, API_BASE_URL, HMAC_SECRET, HMAC_CLIENT_ID
```
to:
```
 * Expects these environment variables to be set:
 *   DATABASE_URL, API_BASE_URL, LOCAL_API_KEY
```

**Replace `apiGet`** with:
```typescript
export async function apiGet(path: string): Promise<Response> {
  const apiKey = process.env.LOCAL_API_KEY ?? 'local-dev-key';
  return fetch(`${API_BASE()}${path}`, {
    method: 'GET',
    headers: {
      'x-api-key': apiKey,
      'content-type': 'application/json',
    },
  });
}
```

**Replace `apiPost`** with:
```typescript
export async function apiPost(path: string, body: unknown = {}): Promise<Response> {
  const apiKey = process.env.LOCAL_API_KEY ?? 'local-dev-key';
  const bodyStr = JSON.stringify(body);
  return fetch(`${API_BASE()}${path}`, {
    method: 'POST',
    headers: {
      'x-api-key': apiKey,
      'content-type': 'application/json',
    },
    body: bodyStr,
  });
}
```

Keep unchanged:
- `getPool()`, `query()`, `closePool()` database helpers
- `pollUntil()` helper
- `API_BASE()` function
- `pg` import
  </action>
  <verify>Run: npx tsc --noEmit --project tests/local/tsconfig.json 2>&1 || echo "No tsconfig, checking manually"; grep -n "hmac\|HMAC\|createHmac\|makeHmacHeaders\|HMAC_SECRET\|HMAC_CLIENT" tests/local/helpers.ts</verify>
  <done>tests/local/helpers.ts contains no HMAC code. apiGet and apiPost use x-api-key header. No import of node:crypto.</done>
</task>

<task type="auto">
  <name>Task 3: Update DIAMOND_OPUS.md auth section and remove HMAC_SECRETS from .env.example</name>
  <files>
    docs/DIAMOND_OPUS.md
    .env.example
  </files>
  <action>
**docs/DIAMOND_OPUS.md — Section 7 (REST API), Authentication subsection:**

Replace the current dual-auth documentation:
```
### Authentication

Dual auth system (checked in order):

1. **API Key Auth**: `X-API-Key` header → SHA256 hash against `api_keys` table
2. **HMAC Auth**: `X-Client-Id`, `X-Timestamp`, `X-Signature` headers
   - Canonical string: `METHOD\nPATH\nTIMESTAMP\nSHA256(BODY)`
   - Timestamp tolerance: 300 seconds (5 minutes)
3. Neither valid → 401 Unauthorized
```

With:
```
### Authentication

API key authentication (single mechanism):

1. **API Key Auth**: `X-API-Key` header → SHA256 hash against `api_keys` table
2. Missing or invalid key → 401 Unauthorized

Repeated auth failures from the same IP trigger a Slack alert after 10 failures within 5 minutes.
```

Also update Section 1 Overview, Key Features bullet: Change `- **Dual authentication**: API Key and HMAC signature support` to `- **API key authentication**: SHA256-hashed API keys stored in database`

Also update Section 14, Environment Variables table: Remove the row for `HMAC_SECRETS`.

Also update the Troubleshooting table (Section 15): The entry `API returning 401 | Verify API key hash, check api_keys.last_used_at` is accurate — keep it as-is.

**.env.example:**

Remove this line:
```
HMAC_SECRETS={"shopify":"secret1","internal":"secret2"}
```

The remaining `# API Configuration` section should just contain:
```
# API Configuration
PORT=3000
```
  </action>
  <verify>grep -n "HMAC\|hmac\|dual auth\|Dual auth\|HMACAuth" docs/DIAMOND_OPUS.md; grep -n "HMAC_SECRETS" .env.example</verify>
  <done>DIAMOND_OPUS.md contains no HMAC references. .env.example contains no HMAC_SECRETS line. Authentication section accurately describes API key-only auth.</done>
</task>

</tasks>

<verification>
Confirm no stray HMAC references remain in the targeted files:
```bash
grep -n "HMAC\|hmac" packages/api/src/routes/system.ts packages/api/src/swagger/generator.ts tests/local/helpers.ts .env.example
```
Expected: zero matches (system.ts and generator.ts may have "API key" references but no HMAC).

Check DIAMOND_OPUS.md:
```bash
grep -n "HMAC\|dual auth\|Dual auth" docs/DIAMOND_OPUS.md
```
Expected: zero matches.
</verification>

<success_criteria>
- system.ts security annotation references ApiKeyAuth only
- swagger generator description contains no HMAC mention
- npm run swagger completes without errors
- tests/local/helpers.ts uses x-api-key header in apiGet/apiPost
- DIAMOND_OPUS.md authentication section describes API key-only auth
- .env.example has no HMAC_SECRETS entry
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-simplification/02-02-SUMMARY.md`
</output>
