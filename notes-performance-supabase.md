â¯ Read the @notes-performance-supabase.md                                                                                                                                                                 
                                                                                                                                                                                                          
  I've added more indexes that supabase has recommended, however, now things are running slow. 15 seconds to get 24 records from the diamonds databse. Here is an example of one of the queries           
                                                                                                                                                                                                          
  shape=ROUND,OVAL,EMERALD,CUSHION,CUSHION+B,CUSHION+MODIFIED,CUSHION+BRILLIANT,RADIANT,PRINCESS,MARQUISE,ASSCHER,HEART,PEAR,ROSE&carat_max=4&clarity=FL,IF,VVS1,VVS2,VS1,VS2&cut=EX,VG,G,F&lab_grown=tr  
  ue&fancy_color=false&price_max=99000&polish=EX,VG&symmetry=EX,VG&availability=available&page=1&limit=24&fields=slim                                                                                     
                                                                                                                                                                                                          
  If you run the script @scripts/analyze-indexes.ts this may help you with your analysis. 

INDEXES
| ddl                                                                                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| CREATE INDEX diamonds_carats_idx ON public.diamonds USING btree (carats);                                                                                                                                                                                    |
| CREATE INDEX diamonds_clarity_idx ON public.diamonds USING btree (clarity);                                                                                                                                                                                  |
| CREATE INDEX diamonds_color_idx ON public.diamonds USING btree (color);                                                                                                                                                                                      |
| CREATE INDEX diamonds_fancy_color_idx ON public.diamonds USING btree (fancy_color);                                                                                                                                                                          |
| CREATE INDEX diamonds_feed_price_idx ON public.diamonds USING btree (feed_price);                                                                                                                                                                            |
| CREATE INDEX diamonds_instock_active_id_idx ON public.diamonds USING btree (id) INCLUDE (feed, feed_price, price_model_price, markup_ratio, rating, carats, lab_grown, fancy_color) WHERE ((availability = 'in_stock'::text) AND (status = 'active'::text)); |
| CREATE INDEX diamonds_lab_grown_idx ON public.diamonds USING btree (lab_grown);                                                                                                                                                                              |
| CREATE INDEX diamonds_price_model_price_idx ON public.diamonds USING btree (price_model_price);                                                                                                                                                              |
| CREATE INDEX diamonds_shape_idx ON public.diamonds USING btree (shape);                                                                                                                                                                                      |
| CREATE INDEX diamonds_status_idx ON public.diamonds USING btree (status);                                                                                                                                                                                    |
| CREATE INDEX diamonds_supplier_idx ON public.diamonds USING btree (feed);                                                                                                                                                                                    |
| CREATE INDEX idx_diamonds_active_created_desc ON public.diamonds USING btree (created_at DESC, id) WHERE (status = 'active'::text);                                                                                                                          |
| CREATE INDEX idx_diamonds_active_price_model_price_id ON public.diamonds USING btree (price_model_price, id) WHERE (status = 'active'::text);                                                                                                                |
| CREATE INDEX idx_diamonds_active_price_per_carat_id ON public.diamonds USING btree (price_per_carat, id) WHERE (status = 'active'::text);                                                                                                                    |
| CREATE INDEX idx_diamonds_available_active_id ON public.diamonds USING btree (availability, status, id) WHERE (status = 'active'::text);                                                                                                                     |
| CREATE INDEX idx_diamonds_available_price ON public.diamonds USING btree (availability, feed_price, id) WHERE ((status = 'active'::text) AND (availability = 'available'::text));                                                                            |
| CREATE INDEX idx_diamonds_carats_sort ON public.diamonds USING btree (carats, id) WHERE (status = 'active'::text);                                                                                                                                           |
| CREATE INDEX idx_diamonds_carats_sort_desc ON public.diamonds USING btree (carats DESC, id) WHERE (status = 'active'::text);                                                                                                                                 |
| CREATE INDEX idx_diamonds_certificate_lab ON public.diamonds USING btree (certificate_lab) WHERE (status = 'active'::text);                                                                                                                                  |
| CREATE INDEX idx_diamonds_certificate_number ON public.diamonds USING btree (certificate_number) WHERE ((status = 'active'::text) AND (certificate_number IS NOT NULL));                                                                                     |
| CREATE INDEX idx_diamonds_clarity ON public.diamonds USING btree (clarity) WHERE ((status = 'active'::text) AND (clarity IS NOT NULL));                                                                                                                      |
| CREATE INDEX idx_diamonds_color ON public.diamonds USING btree (color) WHERE ((status = 'active'::text) AND (color IS NOT NULL));                                                                                                                            |
| CREATE INDEX idx_diamonds_cut ON public.diamonds USING btree (cut) WHERE (status = 'active'::text);                                                                                                                                                          |
| CREATE INDEX idx_diamonds_deleted ON public.diamonds USING btree (deleted_at) WHERE (status = 'deleted'::text);                                                                                                                                              |
| CREATE INDEX idx_diamonds_fancy_color ON public.diamonds USING btree (fancy_color) WHERE ((status = 'active'::text) AND (fancy_color IS NOT NULL));                                                                                                          |
| CREATE INDEX idx_diamonds_fancy_intensity ON public.diamonds USING btree (fancy_intensity) WHERE ((status = 'active'::text) AND (fancy_intensity IS NOT NULL));                                                                                              |
| CREATE INDEX idx_diamonds_fluorescence_intensity ON public.diamonds USING btree (fluorescence_intensity) WHERE (status = 'active'::text);                                                                                                                    |
| CREATE INDEX idx_diamonds_lab_grown ON public.diamonds USING btree (lab_grown) WHERE (status = 'active'::text);                                                                                                                                              |
| CREATE INDEX idx_diamonds_lab_grown_price ON public.diamonds USING btree (lab_grown, feed_price, id) WHERE (status = 'active'::text);                                                                                                                        |
| CREATE INDEX idx_diamonds_lab_grown_price_model ON public.diamonds USING btree (lab_grown, price_model_price, id) WHERE (status = 'active'::text);                                                                                                           |
| CREATE INDEX idx_diamonds_offer ON public.diamonds USING btree (offer_id);                                                                                                                                                                                   |
| CREATE INDEX idx_diamonds_polish ON public.diamonds USING btree (polish) WHERE (status = 'active'::text);                                                                                                                                                    |
| CREATE INDEX idx_diamonds_price ON public.diamonds USING btree (feed_price) WHERE (status = 'active'::text);                                                                                                                                                 |
| CREATE INDEX idx_diamonds_rating ON public.diamonds USING btree (rating) WHERE ((status = 'active'::text) AND (rating IS NOT NULL));                                                                                                                         |
| CREATE INDEX idx_diamonds_ratio ON public.diamonds USING btree (ratio) WHERE ((status = 'active'::text) AND (ratio IS NOT NULL));                                                                                                                            |
| CREATE INDEX idx_diamonds_search_covering ON public.diamonds USING btree (shape, carats, color, clarity, cut, feed_price, certificate_lab, id) WHERE ((status = 'active'::text) AND (lab_grown = false));                                                    |
| CREATE INDEX idx_diamonds_search_v2 ON public.diamonds USING btree (status, lab_grown, shape, carats, color, clarity) WHERE (status = 'active'::text);                                                                                                       |
| CREATE INDEX idx_diamonds_shape ON public.diamonds USING btree (shape) WHERE (status = 'active'::text);                                                                                                                                                      |
| CREATE INDEX idx_diamonds_shape_avail ON public.diamonds USING btree (shape, availability) WHERE (status = 'active'::text);                                                                                                                                  |
| CREATE INDEX idx_diamonds_shape_carats ON public.diamonds USING btree (shape, carats, id) WHERE (status = 'active'::text);                                                                                                                                   |
| CREATE INDEX idx_diamonds_symmetry ON public.diamonds USING btree (symmetry) WHERE (status = 'active'::text);                                                                                                                                                |
| CREATE UNIQUE INDEX uq_diamonds_feed_offer_id ON public.diamonds USING btree (feed, offer_id);                                                                                                                                                               |


EXPLAIN analyze
select
  COUNT(*) as count
from
  diamonds
where
  status = 'active'
  and shape = any (ARRAY['ROUND','OVAL','EMERALD'])
  and availability = any (ARRAY['available'])

RESULTS

| QUERY PLAN                                                                                                                                                                       |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Finalize Aggregate  (cost=10629.91..10629.92 rows=1 width=8) (actual time=360.153..363.569 rows=1 loops=1)                                                                       |
|   ->  Gather  (cost=10629.80..10629.91 rows=1 width=8) (actual time=359.341..363.562 rows=2 loops=1)                                                                             |
|         Workers Planned: 1                                                                                                                                                       |
|         Workers Launched: 1                                                                                                                                                      |
|         ->  Partial Aggregate  (cost=9629.80..9629.81 rows=1 width=8) (actual time=355.899..355.899 rows=1 loops=2)                                                              |
|               ->  Parallel Index Only Scan using idx_diamonds_shape_avail on diamonds  (cost=0.42..8949.27 rows=272210 width=0) (actual time=1.360..342.459 rows=231936 loops=2) |
|                     Index Cond: ((shape = ANY ('{ROUND,OVAL,EMERALD}'::text[])) AND (availability = ANY ('{available}'::text[])))                                                |
|                     Heap Fetches: 4953                                                                                                                                           |
| Planning Time: 2.827 ms                                                                                                                                                          |
| Execution Time: 363.685 ms                                                                                                                                                       |
.

This query


EXPLAIN ANALYZE                                                                                                                               
  SELECT COUNT(*) as count FROM diamonds                          
  WHERE status = 'active'                
    AND shape = ANY(ARRAY['ROUND','OVAL','EMERALD'])
    AND carats >= 1 AND carats <= 2.2
    AND color = ANY(ARRAY['D','E','F','G','H'])
    AND clarity = ANY(ARRAY['FL','IF','VVS1','VVS2','VS1','VS2','SI1','SI2'])
    AND UPPER(cut) = ANY(ARRAY['EX','VG'])
    AND UPPER(polish) = ANY(ARRAY['EX','VG','G'])
    AND UPPER(symmetry) = ANY(ARRAY['EX'])
    AND availability = ANY(ARRAY['available']);


RESULTS

| QUERY PLAN                                                                                                                                                                                                                        |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Aggregate  (cost=72386.25..72386.26 rows=1 width=8) (actual time=21543.807..21543.808 rows=1 loops=1)                                                                                                                             |
|   ->  Index Scan using idx_diamonds_search_v2 on diamonds  (cost=0.42..72386.25 rows=1 width=0) (actual time=35.302..21537.327 rows=37355 loops=1)                                                                                |
|         Index Cond: ((shape = ANY ('{ROUND,OVAL,EMERALD}'::text[])) AND (carats >= '1'::numeric) AND (carats <= 2.2) AND (color = ANY ('{D,E,F,G,H}'::text[])) AND (clarity = ANY ('{FL,IF,VVS1,VVS2,VS1,VS2,SI1,SI2}'::text[]))) |
|         Filter: ((availability = ANY ('{available}'::text[])) AND (upper(symmetry) = ANY ('{EX}'::text[])) AND (upper(cut) = ANY ('{EX,VG}'::text[])) AND (upper(polish) = ANY ('{EX,VG,G}'::text[])))                            |
|         Rows Removed by Filter: 105092                                                                                                                                                                                            |
| Planning Time: 3.399 ms                                                                                                                                                                                                           |
| Execution Time: 21544.011 ms                                                                                                                                                                                                      |



Here are some other slow queries


| query                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | rolname  | calls | mean_time        | min_time     | max_time     | total_time    | rows_read | cache_hit_rate      | prop_total_time    | index_advisor_result |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ----- | ---------------- | ------------ | ------------ | ------------- | --------- | ------------------- | ------------------ | -------------------- |
| SELECT COUNT(*) as count FROM diamonds WHERE status = 'active' AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND feed_price <= $6 AND availability = ANY($7)                                                                                                                                                                                                                                                                                                                                                                                                        | postgres | 5     | 27986.562472     | 24893.382318 | 35103.359463 | 139932.81236  | 5         | 85.6036728156143349 | 11.661055596037864 | null                 |
| SELECT * FROM diamonds WHERE status = $14 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND UPPER(REPLACE(fluorescence_intensity, $15, $16)) = ANY($8) AND UPPER(polish) = ANY($9) AND UPPER(symmetry) = ANY($10) AND availability = ANY($11) ORDER BY carats ASC NULLS LAST LIMIT $12 OFFSET $13                                                                                                                                                                                                                     | postgres | 5     | 24045.092907     | 24033.152514 | 24054.32525  | 120225.464535 | 120       | 89.1906638682973005 | 10.018778314805488 | null                 |
| SELECT * FROM diamonds WHERE status = $10 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND clarity = ANY($4) AND lab_grown = $5 AND feed_price <= $6 AND (fancy_color IS NULL OR fancy_color = $11) AND availability = ANY($7) ORDER BY clarity ASC NULLS LAST LIMIT $8 OFFSET $9                                                                                                                                                                                                                                                                                                                            | postgres | 9     | 12662.1647144444 | 15.300739    | 17347.5486   | 113959.48243  | 216       | 15.7615450807916627 | 9.496613681236886  | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $12 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND UPPER(REPLACE(fluorescence_intensity, $13, $14)) = ANY($8) AND UPPER(polish) = ANY($9) AND UPPER(symmetry) = ANY($10) AND availability = ANY($11)                                                                                                                                                                                                                                                         | postgres | 5     | 18159.9026994    | 17397.042407 | 18993.938362 | 90799.513497  | 5         | 93.4298560618557573 | 7.566618272901746  | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $10 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND UPPER(polish) = ANY($8) AND availability = ANY($9)                                                                                                                                                                                                                                                                                                                                                        | postgres | 4     | 22416.43494425   | 21846.156474 | 22840.775515 | 89665.739777  | 4         | 89.4917974548637984 | 7.472137227610999  | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $8 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND clarity = ANY($4) AND lab_grown = $5 AND feed_price <= $6 AND (fancy_color IS NULL OR fancy_color = $9) AND availability = ANY($7)                                                                                                                                                                                                                                                                                                                                                                 | postgres | 23    | 3514.77860613043 | 226.932523   | 14574.704523 | 80839.907941  | 23        | 79.6285109852612530 | 6.736652004487617  | null                 |
| SELECT * FROM diamonds WHERE status = $13 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND UPPER(polish) = ANY($8) AND UPPER(symmetry) = ANY($9) AND availability = ANY($10) ORDER BY carats ASC NULLS LAST LIMIT $11 OFFSET $12                                                                                                                                                                                                                                                                                     | postgres | 3     | 24057.6958263333 | 24043.133438 | 24069.008171 | 72173.087479  | 72        | 84.6266397151483884 | 6.01441771544713   | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $9 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND availability = ANY($8)                                                                                                                                                                                                                                                                                                                                                                                     | postgres | 3     | 23671.3762286667 | 23468.986564 | 23804.074578 | 71014.128686  | 3         | 91.3576487142287135 | 5.917837916250918  | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $9 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND lab_grown = $6 AND feed_price <= $7 AND (fancy_color IS NULL OR fancy_color = $10) AND availability = ANY($8)                                                                                                                                                                                                                                                                                                                                            | postgres | 11    | 5882.47076309091 | 2124.927124  | 16978.51129  | 64707.178394  | 11        | 61.0464945338699440 | 5.39225927064169   | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $11 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND UPPER(polish) = ANY($8) AND UPPER(symmetry) = ANY($9) AND availability = ANY($10)                                                                                                                                                                                                                                                                                                                         | postgres | 3     | 19955.9786373333 | 19699.137129 | 20205.256829 | 59867.935912  | 3         | 90.0112067324974098 | 4.9889894822797345 | null                 |
| SELECT * FROM diamonds WHERE status = $11 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND lab_grown = $6 AND feed_price <= $7 AND (fancy_color IS NULL OR fancy_color = $12) AND availability = ANY($8) ORDER BY price_model_price ASC NULLS LAST LIMIT $9 OFFSET $10                                                                                                                                                                                                                                                                                             | postgres | 1     | 43957.273788     | 43957.273788 | 43957.273788 | 43957.273788  | 24        | 65.7738515375985378 | 3.663102347813956  | null                 |
| SELECT * FROM diamonds WHERE status = $11 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND lab_grown = $6 AND feed_price <= $7 AND (fancy_color IS NULL OR fancy_color = $12) AND availability = ANY($8) ORDER BY clarity ASC NULLS LAST LIMIT $9 OFFSET $10                                                                                                                                                                                                                                                                                                       | postgres | 7     | 5547.445296      | 19.685125    | 9042.357054  | 38832.117072  | 168       | 51.3002243524372833 | 3.2360063980096445 | null                 |
| SELECT * FROM diamonds WHERE status = $10 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND clarity = ANY($4) AND lab_grown = $5 AND feed_price <= $6 AND fancy_color IS NOT NULL AND fancy_color != $11 AND availability = ANY($7) ORDER BY color ASC NULLS LAST LIMIT $8 OFFSET $9                                                                                                                                                                                                                                                                                                                          | postgres | 1     | 38805.748882     | 38805.748882 | 38805.748882 | 38805.748882  | 24        | 36.2190474889711406 | 3.233809051123155  | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $7 AND shape = ANY($1) AND carats <= $2 AND color = ANY($3) AND lab_grown = $4 AND feed_price <= $5 AND (fancy_color IS NULL OR fancy_color = $8) AND availability = ANY($6)                                                                                                                                                                                                                                                                                                                                                                                    | postgres | 6     | 5128.0217055     | 2401.252363  | 16253.129514 | 30768.130233  | 6         | 26.9167394961466584 | 2.5640081920893825 | null                 |
| SELECT COUNT(*) as count FROM diamonds WHERE status = $12 AND shape = ANY($1) AND carats <= $2 AND color = ANY($3) AND clarity = ANY($4) AND cut = ANY($5) AND lab_grown = $6 AND feed_price <= $7 AND (fancy_color IS NULL OR fancy_color = $13) AND fluorescence_intensity = ANY($8) AND polish = ANY($9) AND symmetry = ANY($10) AND availability = ANY($11)                                                                                                                                                                                                                                                       | postgres | 4     | 7213.44612325    | 1209.155909  | 11011.847463 | 28853.784493  | 4         | 50.3717709380434956 | 2.404479545964927  | null                 |
| SELECT * FROM diamonds WHERE status = $14 AND shape = ANY($1) AND carats <= $2 AND color = ANY($3) AND clarity = ANY($4) AND cut = ANY($5) AND lab_grown = $6 AND feed_price <= $7 AND (fancy_color IS NULL OR fancy_color = $15) AND fluorescence_intensity = ANY($8) AND polish = ANY($9) AND symmetry = ANY($10) AND availability = ANY($11) ORDER BY created_at DESC NULLS LAST LIMIT $12 OFFSET $13                                                                                                                                                                                                              | postgres | 4     | 6794.57044125    | 3046.608986  | 10579.62582  | 27178.281765  | 96        | 44.8219748487374513 | 2.26485446351996   | null                 |
| SELECT * FROM diamonds WHERE status = $12 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND UPPER(cut) = ANY($6) AND feed_price <= $7 AND UPPER(polish) = ANY($8) AND availability = ANY($9) ORDER BY carats ASC NULLS LAST LIMIT $10 OFFSET $11                                                                                                                                                                                                                                                                                                                    | postgres | 4     | 6076.88648875    | 79.28599     | 24044.727412 | 24307.545955  | 96        | 89.1358504268812755 | 2.0256267275989184 | null                 |
| SELECT * FROM diamonds WHERE status = $10 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND feed_price <= $6 AND availability = ANY($7) ORDER BY rating DESC NULLS LAST LIMIT $8 OFFSET $9                                                                                                                                                                                                                                                                                                                                                                          | postgres | 1     | 24053.382004     | 24053.382004 | 24053.382004 | 24053.382004  | 24        | 88.3518967922522417 | 2.0044464203276346 | null                 |
| EXPLAIN ANALYZE                                                                                                                               
  SELECT COUNT(*) as count FROM diamonds                          
  WHERE status = $1                
    AND shape = ANY(ARRAY[$2,$3,$4])
    AND carats >= $5 AND carats <= $6
    AND color = ANY(ARRAY[$7,$8,$9,$10,$11])
    AND clarity = ANY(ARRAY[$12,$13,$14,$15,$16,$17,$18,$19])
    AND UPPER(cut) = ANY(ARRAY[$20,$21])
    AND UPPER(polish) = ANY(ARRAY[$22,$23,$24])
    AND UPPER(symmetry) = ANY(ARRAY[$25])
    AND availability = ANY(ARRAY[$26]) | postgres | 1     | 21547.695555     | 21547.695555 | 21547.695555 | 21547.695555  | 0         | 67.4551322418136020 | 1.7956394329224423 | null                 |
| SELECT * FROM diamonds WHERE status = $10 AND shape = ANY($1) AND carats >= $2 AND carats <= $3 AND color = ANY($4) AND clarity = ANY($5) AND feed_price <= $6 AND availability = ANY($7) ORDER BY price_model_price DESC NULLS LAST LIMIT $8 OFFSET $9                                                                                                                                                                                                                                                                                                                                                               | postgres | 1     | 18512.034477     | 18512.034477 | 18512.034477 | 18512.034477  | 24        | 65.9780620072360919 | 1.5426679389299076 | null                 |
